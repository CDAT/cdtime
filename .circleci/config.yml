version: 2

aliases:
  - &setup_miniconda
    name: setup_miniconda
    command: |
       mkdir -p workspace
       git clone -b validateNightly git@github.com:CDAT/cdat workspace/cdat
       # install_miniconda.py installs miniconda3 under $WORKDIR/miniconda
       WORKDIR=`pwd`
       python workspace/cdat/scripts/install_miniconda.py -w $WORKDIR -p 'py3'

  - &prep_for_build
    name: prep_for_build
    command: |
       git clone -b sync_recipe https://github.com/CDAT/conda-recipes.git conda-recipes 
       source miniconda/etc/profile.d/conda.sh
       conda activate base
       WORKDIR=`pwd`
       python conda-recipes/build_tools/conda_rerender.py -w $WORKDIR -l $LAST_STABLE -B 0 -p $PKG_NAME -b $CIRCLE_BRANCH

  - &build_pkg
    name: build_pkg
    command: |
       git clone -b sync_recipe https://github.com/CDAT/conda-recipes.git conda-recipes 
       source miniconda/etc/profile.d/conda.sh
       conda activate base
       WORKDIR=`pwd`
       python conda-recipes/build_tools/conda_build.py -w $WORKDIR -p $PKG_NAME -V $PY_VER

  - &setup_run_tests
    name: setup_run_tests
    environment:
       PKGS: "numpy cdat_info libcdms libdrs_f testsrunner 'libnetcdf=4.6.2'"
       CHANNELS: "-c cdat/label/nightly -c conda-forge"
    command: |
       source miniconda/etc/profile.d/conda.sh
       conda activate base
       conda create -y -n $ENV_NAME --use-local $CHANNELS "$PY_VER" $PKG_NAME $PKGS
       conda activate $ENV_NAME
       conda list

  - &run_tests
    name: run_tests
    command: |
       source miniconda/etc/profile.d/conda.sh
       conda activate $ENV_NAME
       python -c "import $PKG_NAME; import sys; print(sys.path)"
       python run_tests.py -H -v2 -n 2

jobs:
   macos_setup:
      macos:
         xcode: "11.1.0"
      environment:
         PKG_NAME: "cdtime"
         LAST_STABLE: "3.1.2"
      steps:
         - run: *setup_miniconda
         - run: *prep_for_build
         - persist_to_workspace:
              root: .
              paths: 
                 - miniconda

   linux_setup:
      machine:
         image: circleci/classic:latest
      environment:
         PKG_NAME: "cdtime"
         LAST_STABLE: "3.1.2"
      steps:
         - attach_workspace:
              at: .
         - run: *setup_miniconda
         - run: *prep_for_build
         - persist_to_workspace:
              root: .
              paths:
                 - miniconda

   macos_cdtime_py2:
      macos:
         xcode: "11.1.0"
      environment:
         PKG_NAME: "cdtime"
         ENV_NAME: "test_cdtime"
         PY_VER: "python<3"
         BUILD_VARIANT_VER: "2.7"
      steps:
         - checkout
         - attach_workspace:
              at: .
         - run: *build_pkg
         - run: *setup_run_tests
         - run: *run_tests
         - store_artifacts:
              path: tests_html
              destination: tests_html
         - store_artifacts:
             path: tests_png
             destination: tests_png

   macos_cdtime_py37:
      macos:
         xcode: "11.1.0"
      environment:
         PKG_NAME: "cdtime"
         ENV_NAME: "test_cdtime"
         PY_VER: "python>=3.7,<3.8"
         BUILD_VARIANT_VER: "3.7"
      steps:
         - checkout
         - attach_workspace:
              at: .
         - run: *build_pkg
         - run: *setup_run_tests
         - run: *run_tests
         - store_artifacts:
              path: tests_html
              destination: tests_html
         - store_artifacts:
             path: tests_png
             destination: tests_png

   linux_cdtime_py2:
      machine:
         image: circleci/classic:latest
      environment:
         PKG_NAME: "cdtime"
         ENV_NAME: "test_cdtime"
         PY_VER: "python<3"
         BUILD_VARIANT_VER: "2.7"
      steps:
         - checkout
         - attach_workspace:
              at: .
         - run: *build_pkg
         - run: *setup_run_tests
         - run: *run_tests
         - store_artifacts:
              path: tests_html
              destination: tests_html
         - store_artifacts:
             path: tests_png
             destination: tests_png

   linux_cdtime_py37:
      machine:
         image: circleci/classic:latest
      environment:
         PKG_NAME: "cdtime"
         ENV_NAME: "test_cdtime"
         PY_VER: "python>=3.7,<3.8"
         BUILD_VARIANT_VER: "3.7"
      steps:
         - checkout
         - attach_workspace:
              at: .
         - run: *build_pkg
         - run: *setup_run_tests
         - run: *run_tests
         - store_artifacts:
              path: tests_html
              destination: tests_html
         - store_artifacts:
             path: tests_png
             destination: tests_png

workflows:
   version: 2
   cdtime:
      jobs:
         - macos_setup
         - linux_setup
         - macos_cdtime_py2:
              requires:
                 - macos_setup
         - macos_cdtime_py37:
              requires:
                 - macos_setup
         - linux_cdtime_py2:
              requires:
                 - linux_setup
         - linux_cdtime_py37:
              requires:
                 - linux_setup
